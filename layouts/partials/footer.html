<!--  -->
<footer class="footer">
  <span>© {{ now.Format "2006" }} {{ .Site.Title }}</span>
</footer>

{{- partial "extend_footer.html" . -}}

<div id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'});">
  TOP
</div>

<script>
  (function() {
    // TOP 按鈕顯示控制
    var btn = document.getElementById('back-to-top');
    if (btn) {
      window.addEventListener('scroll', function() {
        if (window.scrollY > 200) {
          btn.classList.add('show');
        } else {
          btn.classList.remove('show');
        }
      });
    }
  })();
</script>
<script>
(function () {
  function initWorkRing(ring) {
    const items = Array.from(ring.querySelectorAll(".work-ring-item"));
    if (!items.length) return;

    const phases = items.map(() => Math.random() * Math.PI * 2);

    let focus = 0;
    let paused = false;

    ring.addEventListener("mouseenter", () => paused = true);
    ring.addEventListener("mouseleave", () => paused = false);

    items.forEach((el, idx) => {
      el.style.cursor = "pointer";
      el.addEventListener("click", (e) => {
        e.preventDefault();
        focus = idx;
      });
    });

    let t = Math.random() * Math.PI * 2;

    function calcParams() {
      const w = ring.clientWidth || 1;
      const h = ring.clientHeight || 1;
      return {
        radiusX: Math.min(w, h) * 0.56,
        radiusY: Math.min(w, h) * 0.06,
        depthZ:  360,
        speed:   0.00045
      };
    }

    function render() {
      const { radiusX, radiusY, depthZ, speed } = calcParams();
      if (!paused) t += speed;

      const focusAngle = (focus / items.length) * Math.PI * 2 + phases[focus];
      const offset = -focusAngle;

      const frontK = 3;
      const sepPx = 120;
      const fadeStart = 0.25;
      const fadeEnd   = 0.62;

      const info = items.map((el, idx) => {
        const a = (idx / items.length) * Math.PI * 2 + phases[idx] + t + offset;
        const d = Math.atan2(Math.sin(a), Math.cos(a));
        return { idx, a, d, absd: Math.abs(d) };
      }).sort((x, y) => x.absd - y.absd);

      const frontIdx = info.slice(0, Math.min(frontK, info.length)).map(x => x.idx);

      const frontOrder = new Map();
      const slots = [0, -1, 1];
      info.slice(0, Math.min(frontK, info.length)).forEach((x, k) => {
        frontOrder.set(x.idx, slots[k] ?? 0);
      });

      // 提速：做一個 idx->record 的 map，避免 find
      const recMap = new Map(info.map(r => [r.idx, r]));

      items.forEach((el, idx) => {
        const rec = recMap.get(idx);
        const a = rec.a;

        el.classList.toggle("is-front", frontIdx.includes(idx));

        const xBase = Math.cos(a) * radiusX;
        const y = Math.sin(a) * radiusY;
        const z = Math.sin(a) * depthZ;

        const depth01 = (z + depthZ) / (2 * depthZ);
        const dist01 = Math.min(rec.absd / Math.PI, 1);

        // 後方淡出 + 消失
        let op = 0.88;
        if (dist01 > fadeStart) {
          const t2 = Math.min((dist01 - fadeStart) / (fadeEnd - fadeStart), 1);
          op = 0.88 * (1 - t2) * (1 - t2);
        }
        if (dist01 >= fadeEnd) op = 0;

        const blur = Math.max(0, (dist01 - 0.15) * 10);
        const dark = 1 - Math.max(0, (dist01 - 0.10) * 0.65);
        el.style.filter = `blur(${blur.toFixed(2)}px) brightness(${dark.toFixed(2)})`;

        let scale = 0.78 + depth01 * 0.60;
        if (idx === focus) scale *= 1.18;

        const sep = frontOrder.has(idx) ? (frontOrder.get(idx) * sepPx) : 0;

        el.style.transform =
          `translate3d(calc(-50% + ${(xBase + sep).toFixed(2)}px), calc(-50% + ${y.toFixed(2)}px), ${z.toFixed(2)}px) scale(${scale.toFixed(3)})`;
        el.style.opacity = op.toFixed(3);
        el.style.zIndex = String(Math.round(depth01 * 1000));
        el.style.pointerEvents = op <= 0.02 ? "none" : "auto";
      });

      requestAnimationFrame(render);
    }

    render();
  }

  function boot() {
    document.querySelectorAll(".work-ring[data-autospin='1']").forEach(initWorkRing);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", boot);
  } else {
    boot();
  }
})();
</script>
<!-- Back to Top Button -->
<div id="back-to-top" aria-label="Back to top">
 <img src="{{ "images/top.png" | relURL }}" alt="TOP">

</div>

<script>
(function () {
  const btn = document.getElementById("back-to-top");
  if (!btn) return;

  // 點擊回到最上方
  btn.addEventListener("click", function () {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  // 滾動超過一點距離才顯示
  window.addEventListener("scroll", function () {
    if (window.scrollY > 200) {
      btn.classList.add("show");
    } else {
      btn.classList.remove("show");
    }
  });
})();
</script>
